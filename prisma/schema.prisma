// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String
  username      String?   @unique
  passwordHash  String    @map("password_hash")
  avatarUrl     String?   @map("avatar_url")
  bio           String?   @db.Text
  location      String?
  
  // ⭐ NEW: Important dates synced from FamilyTreeNode
  birthday           DateTime? @db.Date
  weddingAnniversary DateTime? @map("wedding_anniversary") @db.Date
  deathDay           DateTime? @map("death_day") @db.Date
  
  // Online status tracking
  isOnline      Boolean   @default(false) @map("is_online")
  lastSeenAt    DateTime? @map("last_seen_at")
  
  deletedAt     DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  familyMemberships FamilyMember[]
  createdFamilies   Family[]         @relation("FamilyCreator")
  ownedFamilies     Family[]         @relation("FamilyOwner")
  posts             Post[]
  postComments      Comment[]
  commentLikes      CommentLike[]
  reactions         Reaction[]
  recipes           Recipe[]
  recipeComments    RecipeComment[]
  calendarEvents    CalendarEvent[]
  eventAttendees    EventAttendee[]
  sentInvitations   Invitation[]     @relation("InvitationSender")
  treeNode          FamilyTreeNode?  @relation("UserTreeNode")
  uploadedPhotos    Photo[]
  createdTreeNodes  FamilyTreeNode[] @relation("TreeNodeCreator")
  emailChanges      EmailChange[]
  passwordResets    PasswordReset[]
  notifications     Notification[]
  createdAlbums     Album[]          @relation("CreatedAlbums") // ⭐ NEW

  @@map("users")
}

// ============================================
// FAMILIES & MEMBERSHIPS
// ============================================

model Family {
  id          String  @id @default(uuid())
  name        String
  description String?
  avatarUrl   String? @map("avatar_url")

  // Invitation system
  inviteCode String @unique @map("invite_code")

  // creator/owner
  createdBy String   @map("created_by")
  ownerId   String?  @map("owner_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  creator        User               @relation("FamilyCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  owner          User?              @relation("FamilyOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  members        FamilyMember[]
  posts          Post[]
  photos         Photo[]
  recipes        Recipe[]
  calendarEvents CalendarEvent[]
  treeNodes      FamilyTreeNode[]
  invitations    Invitation[]
  inviteCodes    FamilyInviteCode[]
  albums         Album[] // ⭐ NEW

  @@map("families")
}

enum FamilyRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@map("family_role")
}

model FamilyMember {
  userId   String     @map("user_id")
  familyId String     @map("family_id")
  role     FamilyRole @default(MEMBER)

  status MemberStatus @default(ACTIVE)

  joinedAt DateTime @default(now()) @map("joined_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@id([userId, familyId])
  @@map("family_members")
}

enum MemberStatus {
  PENDING
  ACTIVE
  BLOCKED

  @@map("member_status")
}

// ============================================
// INVITATIONS
// ============================================

model Invitation {
  id       String @id @default(uuid())
  familyId String @map("family_id")

  email      String
  treeNodeId String? @map("tree_node_id")

  inviteCode String @unique @map("invite_code")
  invitedBy  String @map("invited_by")

  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime         @map("expires_at")
  acceptedAt DateTime?        @map("accepted_at")

  createdAt DateTime @default(now()) @map("created_at")

  family   Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  inviter  User            @relation("InvitationSender", fields: [invitedBy], references: [id], onDelete: Cascade)
  treeNode FamilyTreeNode? @relation(fields: [treeNodeId], references: [id], onDelete: SetNull)

  @@index([inviteCode])
  @@index([email, status])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED

  @@map("invitation_status")
}

model FamilyInviteCode {
  id       String @id @default(uuid())
  familyId String @map("family_id")
  code     String @unique

  createdBy String    @map("created_by")
  expiresAt DateTime? @map("expires_at")

  maxUses   Int? @map("max_uses")
  timesUsed Int  @default(0) @map("times_used")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@map("family_invite_codes")
}

// ============================================
// FAMILY TREE
// ============================================

model FamilyTreeNode {
  id       String @id @default(uuid())
  familyId String @map("family_id")

  firstName String    @map("first_name")
  lastName  String?   @map("last_name")
  birthDate DateTime? @map("birth_date") @db.Date
  deathDate DateTime? @map("death_date") @db.Date
  gender    String?
  photoUrl  String?   @map("photo_url")
  bio       String?   @db.Text
  weddingAnniversary DateTime? @map("wedding_anniversary") @db.Date

  userId          String? @unique @map("user_id")
  isAccountHolder Boolean @default(false) @map("is_account_holder")

  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  family  Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user    User?  @relation("UserTreeNode", fields: [userId], references: [id], onDelete: SetNull)
  creator User   @relation("TreeNodeCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  relationshipsFrom FamilyRelationship[] @relation("Person1")
  relationshipsTo   FamilyRelationship[] @relation("Person2")

  invitations Invitation[]

  @@index([familyId])
  @@index([userId])
  @@index([familyId, createdAt])
  @@map("family_tree_nodes")
}

model FamilyRelationship {
  id        String @id @default(uuid())
  person1Id String @map("person1_id")
  person2Id String @map("person2_id")

  relationshipType RelationshipType @map("relationship_type")

  createdAt DateTime @default(now()) @map("created_at")

  person1 FamilyTreeNode @relation("Person1", fields: [person1Id], references: [id], onDelete: Cascade)
  person2 FamilyTreeNode @relation("Person2", fields: [person2Id], references: [id], onDelete: Cascade)

  @@unique([person1Id, person2Id, relationshipType])
  @@index([person1Id])
  @@index([person2Id])
  @@map("family_relationships")
}

enum RelationshipType {
  PARENT
  CHILD
  SPOUSE
  SIBLING
  GRANDPARENT
  GRANDCHILD
  AUNT_UNCLE
  NIECE_NEPHEW
  COUSIN

  @@map("relationship_type")
}

// ============================================
// POSTS & FEED
// ============================================

model Post {
  id       String  @id @default(uuid())
  familyId String  @map("family_id")
  authorId String? @map("author_id")

  content  String? @db.Text
  location String?

  tags      String[]  @default([])
  eventDate DateTime? @map("event_date") @db.Date
  
  // ⭐ NEW: Link to calendar event
  calendarEventId String? @map("calendar_event_id")

  visibility Visibility @default(FAMILY)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  family        Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  author        User?          @relation(fields: [authorId], references: [id], onDelete: SetNull)
  calendarEvent CalendarEvent? @relation(fields: [calendarEventId], references: [id], onDelete: SetNull) // ⭐ NEW
  photos        Photo[]
  comments      Comment[]
  reactions     Reaction[]

  @@index([familyId, createdAt(sort: Desc)])
  @@index([calendarEventId]) // ⭐ NEW
  @@map("posts")
}

enum Visibility {
  FAMILY
  PRIVATE
  CUSTOM
  PUBLIC

  @@map("visibility")
}

model Photo {
  id         String  @id @default(uuid())
  postId     String? @map("post_id")
  familyId   String  @map("family_id")
  uploadedBy String? @map("uploaded_by")

  cloudinaryId String  @map("cloudinary_id")
  url          String
  thumbnailUrl String? @map("thumbnail_url")

  caption   String? @db.Text
  sizeBytes Int?    @map("size_bytes")
  width     Int?
  height    Int?

  uploadedAt DateTime @default(now()) @map("uploaded_at")

  post     Post?         @relation(fields: [postId], references: [id], onDelete: Cascade)
  family   Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploader User?         @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  tags     PhotoTag[]
  albums   AlbumPhoto[]  // ⭐ NEW: Can belong to multiple albums

  @@index([familyId])
  @@index([postId])
  @@map("photos")
}

model PhotoTag {
  id         String @id @default(uuid())
  photoId    String @map("photo_id")
  treeNodeId String @map("tree_node_id")

  x Float?
  y Float?

  taggedAt DateTime @default(now()) @map("tagged_at")

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, treeNodeId])
  @@map("photo_tags")
}

model Comment {
  id     String  @id @default(uuid())
  postId String  @map("post_id")
  userId String? @map("user_id")

  content String @db.Text

  parentId String?   @map("parent_id")
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  post  Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  user  User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  likes CommentLike[]

  @@index([postId])
  @@index([parentId])
  @@map("comments")
}

model CommentLike {
  id        String @id @default(uuid())
  commentId String @map("comment_id")
  userId    String @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@map("comment_likes")
}

model Reaction {
  id     String @id @default(uuid())
  postId String @map("post_id")
  userId String @map("user_id")

  type ReactionType

  createdAt DateTime @default(now()) @map("created_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("reactions")
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  WOW
  SAD

  @@map("reaction_type")
}

// ============================================
// ALBUMS & GALLERY (⭐ NEW)
// ============================================

model Album {
  id          String   @id @default(uuid())
  familyId    String   @map("family_id")
  title       String
  description String?  @db.Text
  coverImage  String?  @map("cover_image")
  tags        String[] @default([])
  
  // Link to calendar event
  calendarEventId String? @unique @map("calendar_event_id")
  
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  family        Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator       User           @relation("CreatedAlbums", fields: [createdBy], references: [id], onDelete: Cascade)
  calendarEvent CalendarEvent? @relation(fields: [calendarEventId], references: [id], onDelete: SetNull)
  photos        AlbumPhoto[]
  
  @@index([familyId])
  @@index([calendarEventId])
  @@map("albums")
}

model AlbumPhoto {
  id       String @id @default(uuid())
  albumId  String @map("album_id")
  photoId  String @map("photo_id")
  
  // Additional metadata for photo in album context
  caption  String? @db.Text
  order    Int     @default(0) // For sorting photos in album
  
  addedBy  String? @map("added_by")
  addedAt  DateTime @default(now()) @map("added_at")
  
  album Album @relation(fields: [albumId], references: [id], onDelete: Cascade)
  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)
  
  @@unique([albumId, photoId])
  @@index([albumId, order]) // For sorted retrieval
  @@map("album_photos")
}

// ============================================
// RECIPES
// ============================================

model Recipe {
  id       String  @id @default(uuid())
  familyId String  @map("family_id")
  authorId String? @map("author_id")

  title       String
  description String? @db.Text

  ingredients  Json
  instructions String @db.Text

  prepTime Int?    @map("prep_time")
  cookTime Int?    @map("cook_time")
  servings Int?
  category String?

  photoUrl String? @map("photo_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  family   Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  author   User?           @relation(fields: [authorId], references: [id], onDelete: SetNull)
  comments RecipeComment[]

  @@index([familyId])
  @@map("recipes")
}

model RecipeComment {
  id       String  @id @default(uuid())
  recipeId String  @map("recipe_id")
  userId   String? @map("user_id")

  content String @db.Text
  rating  Int?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([recipeId])
  @@map("recipe_comments")
}

// ============================================
// CALENDAR & EVENTS (⭐ UPDATED)
// ============================================

model CalendarEvent {
  id        String  @id @default(uuid())
  familyId  String  @map("family_id")
  creatorId String? @map("creator_id")

  title       String
  description String? @db.Text
  location    String?

  // Timing
  startTime DateTime  @map("start_time")
  endTime   DateTime? @map("end_time")
  timezone  String    @default("UTC")
  allDay    Boolean   @default(false) @map("all_day")

  // Recurrence
  isRecurring    Boolean @default(false) @map("is_recurring")
  recurrenceRule String? @map("recurrence_rule")
  
  // ⭐ NEW: Event metadata for better organization
  eventType  String?  @map("event_type") // Birthday, Anniversary, Wedding, Reunion, Holiday, etc.
  coverImage String?  @map("cover_image")
  color      String?  // For calendar display (hex color)
  tags       String[] @default([])
  
  // ⭐ NEW: Google Calendar integration
  googleEventId    String? @unique @map("google_event_id")
  googleCalendarId String? @map("google_calendar_id")
  lastSyncedAt     DateTime? @map("last_synced_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator   User?           @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  attendees EventAttendee[]
  album     Album?          // ⭐ NEW: One-to-one with album
  posts     Post[]          // ⭐ NEW: Multiple posts can reference same event

  @@index([familyId, startTime])
  @@index([googleEventId])
  @@index([eventType])
  @@map("calendar_events")
}

model EventAttendee {
  eventId String @map("event_id")
  userId  String @map("user_id")

  status      RsvpStatus @default(NO_RESPONSE)
  respondedAt DateTime?  @map("responded_at")

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@map("event_attendees")
}

enum RsvpStatus {
  GOING
  MAYBE
  NOT_GOING
  NO_RESPONSE

  @@map("rsvp_status")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(uuid())
  userId String @map("user_id")

  type    NotificationType
  title   String
  message String           @db.Text

  relatedId   String? @map("related_id")
  relatedType String? @map("related_type")
  
  actorId     String? @map("actor_id")
  actorName   String? @map("actor_name")
  actorAvatar String? @map("actor_avatar")

  isRead Boolean @default(false) @map("is_read")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  NEW_POST
  NEW_COMMENT
  NEW_REACTION
  EVENT_REMINDER
  EVENT_INVITATION
  FAMILY_INVITATION
  MEMBER_JOINED
  RECIPE_ADDED
  BIRTHDAY_REMINDER      // ⭐ NEW
  ANNIVERSARY_REMINDER   // ⭐ NEW

  @@map("notification_type")
}

// ============================================
// EMAIL CHANGE & PASSWORD RESET
// ============================================

model EmailChange {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  newEmail  String    @map("new_email")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_changes")
}

model PasswordReset {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime?
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_resets")
}